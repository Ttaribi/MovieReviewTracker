<%- include('partials/header', { title: movie.title, activePage: '' }) %>

<section class="movie-detail">
  <div class="container">
    <a href="/" class="btn btn-outline" style="margin-bottom: 1.5rem;">‚Üê Back to Home</a>
    
    <div class="movie-detail-inner">
      <div class="movie-detail-poster">
        <% if (movie.poster && movie.poster !== 'N/A') { %>
          <img src="<%= movie.poster %>" alt="<%= movie.title %>">
        <% } else { %>
          <div class="no-poster" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:5rem;">üé¨</div>
        <% } %>
      </div>
      
      <div class="movie-detail-info">
        <h1><%= movie.title %></h1>
        
        <div class="movie-meta">
          <span>üìÖ <%= movie.year %></span>
          <% if (movie.runtime && movie.runtime !== 'N/A') { %>
            <span>‚è± <%= movie.runtime %></span>
          <% } %>
          <% if (movie.director && movie.director !== 'N/A') { %>
            <span>üé¨ <%= movie.director %></span>
          <% } %>
        </div>
        
        <% if (movie.plot && movie.plot !== 'N/A' && movie.plot !== '') { %>
          <p class="movie-plot"><%= movie.plot %></p>
        <% } %>
        
        <% if (movie.genre && movie.genre !== 'N/A') { %>
          <div class="movie-tags">
            <% movie.genre.split(', ').forEach(genre => { %>
              <span class="tag"><%= genre %></span>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="review-form-section">
      <h2>Write a Review</h2>
      
      <% if (typeof message !== 'undefined' && message) { %>
        <div class="message <%= messageType === 'error' ? 'message-error' : 'message-success' %>">
          <%= message %>
        </div>
      <% } %>
      
      <form action="/movie/<%= movie.imdbID %>/review" method="POST" id="reviewForm">
        <input type="hidden" name="imdbID" value="<%= movie.imdbID %>">
        <input type="hidden" name="title" value="<%= movie.title %>">
        <input type="hidden" name="year" value="<%= movie.year %>">
        <input type="hidden" name="poster" value="<%= movie.poster %>">
        
        <div class="form-group">
          <label for="reviewerName">Your Name</label>
          <input type="text" id="reviewerName" name="reviewerName" required placeholder="Enter your name">
        </div>
        
        <div class="form-group">
          <label>Rating</label>
          <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5" required>
            <label for="star5">‚òÖ</label>
            <input type="radio" id="star4" name="rating" value="4">
            <label for="star4">‚òÖ</label>
            <input type="radio" id="star3" name="rating" value="3">
            <label for="star3">‚òÖ</label>
            <input type="radio" id="star2" name="rating" value="2">
            <label for="star2">‚òÖ</label>
            <input type="radio" id="star1" name="rating" value="1">
            <label for="star1">‚òÖ</label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="comment">Your Review</label>
          <textarea id="comment" name="comment" required placeholder="Share your thoughts about this movie..."></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="section-header">
      <h2>Reviews (<%= reviews.length %>)</h2>
    </div>
    
    <% if (reviews && reviews.length > 0) { %>
      <div class="cards-grid">
        <% reviews.forEach(review => { %>
          <div class="review-card" data-review-id="<%= review._id %>">
            <div class="review-card-meta" style="margin-bottom: 0.75rem;">
              <p class="reviewer" style="font-size: 1rem; color: var(--text-primary); font-weight: 500;"><%= review.reviewerName %></p>
              <div class="rating">
                <% for (let i = 1; i <= 5; i++) { %>
                  <span class="star <%= i <= review.rating ? 'filled' : '' %>">‚òÖ</span>
                <% } %>
              </div>
            </div>
            <p class="review-card-comment"><%= review.comment %></p>
            <div class="review-card-footer">
              <span class="review-date"><%= new Date(review.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
              <button class="delete-btn" onclick="deleteReview('<%= review._id %>')">Delete</button>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3>No reviews yet</h3>
        <p>Be the first to review this movie!</p>
      </div>
    <% } %>
  </div>
</section>

<script>
  async function deleteReview(reviewId) {
    if (!confirm('Are you sure you want to delete this review?')) return;
    
    try {
      const res = await fetch(`/api/reviews/${reviewId}`, { method: 'DELETE' });
      const data = await res.json();
      
      if (data.success) {
        const card = document.querySelector(`[data-review-id="${reviewId}"]`);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          setTimeout(() => {
            card.remove();
            // Update review count
            const header = document.querySelector('.section-header h2');
            const currentCount = parseInt(header.textContent.match(/\d+/)[0]);
            header.textContent = `Reviews (${currentCount - 1})`;
          }, 200);
        }
      } else {
        alert('Failed to delete review');
      }
    } catch (err) {
      alert('Failed to delete review');
    }
  }
</script>

<%- include('partials/footer') %>

